<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Đặt lịch tư vấn | Drug Prevention Support System</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2176ae;
            --secondary: #57b8ff;
            --bg: #f7fbfd;
            --white: #fff;
            --soft: #eaf4fa;
            --shadow: 0 6px 28px rgba(33,118,174,0.10);
            --highlight: #21ae66;
            --error: #e74c3c;
            --warning: #f39c12;
        }
        body { background: var(--bg); font-family: 'Inter', 'Segoe UI', Arial, sans-serif; margin: 0; color: #24415d;}
        .main-wrap { min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 40px 20px 50px 20px;}
        .consult-title { font-size: 2.2rem; font-weight: 800; color: var(--primary); text-align: center; margin: 20px 0 18px 0;}
        .consult-desc { font-size: 1.12em; color: #355485; background: #eaf6fa; border-radius: 16px; padding: 16px 32px 12px 32px; box-shadow: 0 2px 13px #2176ae13; max-width: 640px; margin: 0 auto 38px auto; text-align: center;}
        .method-select-row { display: flex; flex-wrap: wrap; gap: 32px; justify-content: center; margin: 0 0 38px 0;}
        .method-card { background: var(--white); border-radius: 14px; box-shadow: var(--shadow); padding: 32px 30px 22px 30px; display: flex; flex-direction: column; align-items: center; min-width: 220px; max-width: 290px; cursor: pointer; position: relative; transition: box-shadow 0.15s, transform 0.13s, filter 0.23s; opacity: 0.92; filter: grayscale(25%); border: 2.3px solid transparent;}
        .method-card.selected, .method-card:hover { box-shadow: 0 9px 28px #2176ae2a; transform: scale(1.025) translateY(-2px); border: 2.3px solid var(--primary); filter: grayscale(0%); opacity: 1; background: linear-gradient(106deg, #e8f4fb 68%, #f6faff 100%);}
        .method-icon { font-size: 2.2rem; margin-bottom: 9px; color: var(--primary);}
        .method-title { font-size: 1.18em; font-weight: 700; margin-bottom: 7px;}
        .method-desc { font-size: 1em; color: #426897; text-align: center; margin-bottom: 8px; opacity: 0.93;}
        .form-container { 
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 12px 40px rgba(33, 118, 174, 0.25);
            padding: 30px;
            width: 90%;
            max-width: 600px;
            z-index: 1000;
            display: none;
            max-height: 90vh;
            overflow-y: auto;
        }
        .form-frame { 
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        @keyframes fadeInForm { from { opacity: 0; transform: translate(-50%, -45%);} to { opacity: 1; transform: translate(-50%, -50%);}}
        .form-frame label { display: block; font-weight: 600; margin: 14px 0 6px 0; color: #2e527d; font-size: 1.05em; width: 100%;}
        .form-frame select, .form-frame input, .form-frame textarea { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid #b7d8f5; font-size: 1em; background: #f4fbff; color: #274060; margin-bottom: 5px; transition: border-color 0.2s, box-shadow 0.2s;}
        .form-frame select:focus, .form-frame input:focus, .form-frame textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(33, 118, 174, 0.2); outline: none;}
        .form-frame textarea { resize: vertical; min-height: 58px; max-height: 130px;}
        .form-actions { width: 100%; display: flex; gap: 14px; margin-top: 28px; justify-content: center;}
        .consult-btn, .cancel-btn { flex: 1 1 0; padding: 12px 0; border-radius: 8px; border: none; font-weight: 700; font-size: 1.06em; cursor: pointer; box-shadow: 0 1px 9px #2176ae16; transition: background 0.14s, box-shadow 0.13s, transform 0.13s;}
        .consult-btn { background: linear-gradient(90deg, #2176ae 85%, #57b8ff 100%); color: #fff;}
        .consult-btn:active { transform: scale(0.97);}
        .consult-btn:hover { background: linear-gradient(90deg, #21ae66 80%, #57b8ff 100%);}
        .cancel-btn { background: #eaf4fa; color: #b22626; border: 1.5px solid #e1c9c9; font-weight: 700;}
        .cancel-btn:hover { background: #fbeeee; color: #d41c1c;}
        .hour-list { 
            display: flex;
            flex-wrap: wrap;
            gap: 9px;
            margin: 15px 0;
            width: 100%;
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
        }
        .hour-btn { background: #f4fbff; border: 1.6px solid #b7d8f5; border-radius: 7px; padding: 8px 17px; font-size: 1.02em; font-weight: 600; color: var(--primary); cursor: pointer; transition: background 0.12s, border 0.12s, color 0.12s;}
        .hour-btn.selected, .hour-btn:hover { background: var(--primary); color: #fff; border-color: var(--primary);}
        .hour-btn.disabled { opacity: 0.5; cursor: not-allowed; background: #f0f0f0; color: #999; border-color: #ddd;}
        .error-msg { color: var(--error); font-size: 0.9em; margin-top: -5px; margin-bottom: 10px; width: 100%;}
        .required-field::after { content: " *"; color: var(--error);}
        .time-selection-container {
            width: 100%;
            margin-bottom: 20px;
        }
        .time-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .time-selection-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1em;
        }
        .no-slots-available {
            color: var(--warning);
            font-weight: 600;
            padding: 10px;
            text-align: center;
            width: 100%;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .form-visible {
            display: block;
            animation: fadeInForm 0.3s ease-out;
        }
        .close-form {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }
        .form-header {
            font-size: 1.5em;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }
        /* Success Modal */
        .success-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 12px 40px rgba(33, 118, 174, 0.25);
            padding: 40px 30px;
            width: 90%;
            max-width: 500px;
            z-index: 1001;
            display: none;
            text-align: center;
            animation: fadeInForm 0.3s ease-out;
        }
        .success-modal.show {
            display: block;
        }
        .success-icon {
            font-size: 4em;
            color: var(--highlight);
            margin-bottom: 20px;
        }
        .success-title {
            font-size: 1.5em;
            color: var(--primary);
            margin-bottom: 15px;
            font-weight: 700;
        }
        .success-message {
            color: #426897;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        .success-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .success-btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .btn-home {
            background: var(--primary);
            color: white;
        }
        .btn-home:hover {
            background: #1a5d8a;
        }
        .btn-new {
            background: var(--soft);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        .btn-new:hover {
            background: #d8e9f5;
        }
        @media (max-width: 768px) {
            .form-container {
                width: 95%;
                padding: 20px 15px;
            }
            .method-card {
                min-width: 100%;
            }
            .success-actions {
                flex-direction: column;
            }
            .success-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div th:replace="member/header :: main-header"></div>
<div class="main-wrap">
    <div class="consult-title"><i class="fa-solid fa-headset"></i> Đặt lịch tư vấn</div>
    <div class="consult-desc">Chọn hình thức tư vấn phù hợp: Online (qua Zoom/Meet) hoặc trực tiếp tại văn phòng. Các khung giờ được cập nhật realtime theo chuyên gia bạn chọn!</div>
    <div class="method-select-row" id="methodRow">
        <div class="method-card" data-method="online">
            <div class="method-icon"><i class="fa-solid fa-laptop-medical"></i></div>
            <div class="method-title">Tư vấn Online</div>
            <div class="method-desc">Trao đổi 1-1 cùng chuyên gia qua Zoom, Google Meet. Nhanh, riêng tư, bảo mật.</div>
        </div>
        <div class="method-card" data-method="offline">
            <div class="method-icon"><i class="fa-solid fa-user-doctor"></i></div>
            <div class="method-title">Tư vấn tại văn phòng</div>
            <div class="method-desc">Đến phòng tư vấn chuyên nghiệp, không gian riêng tư, chuyên gia tận tâm hỗ trợ.</div>
        </div>
        <div class="method-card" data-method="hotline">
            <div class="method-icon"><i class="fa-solid fa-phone-volume"></i></div>
            <div class="method-title">Hotline 24/7</div>
            <div class="method-desc">Liên hệ tư vấn gấp với bác sĩ qua số tổng đài.</div>
            <div class="quick-contact-container" style="display:none;">
                <button type="button" class="quick-contact-btn" onclick="copyHotline(event)">
                    <i class="fa fa-copy"></i> Sao chép số
                </button>
                <a href="tel:18001111" class="quick-contact-btn">
                    <i class="fa fa-phone"></i> Gọi ngay 1800 1111
                </a>
            </div>
        </div>
        <div class="method-card" data-method="social">
            <div class="method-icon"><i class="fa-brands fa-facebook-messenger"></i></div>
            <div class="method-title">Mạng xã hội</div>
            <div class="method-desc">Nhắn tin ngay cho tư vấn viên qua Facebook, Zalo, Telegram, Email.</div>
            <div class="quick-contact-container" style="display:none;">
                <a href="https://facebook.com/" target="_blank" class="quick-contact-btn">
                    <i class="fab fa-facebook"></i> Facebook
                </a>
                <a href="https://zalo.me/" target="_blank" class="quick-contact-btn">
                    <i class="fa-brands fa-facebook-messenger"></i> Zalo
                </a>
                <a href="https://t.me/" target="_blank" class="quick-contact-btn">
                    <i class="fab fa-telegram"></i> Telegram
                </a>
                <a href="mailto:info@drugprevention.vn" class="quick-contact-btn">
                    <i class="fa fa-envelope"></i> Email
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay"></div>

<!-- Form đặt lịch -->
<div class="form-container" id="formContainer">
    <button class="close-form" onclick="closeBookingForm()">&times;</button>
    <div class="form-header">Đặt lịch tư vấn</div>
    
    <form class="form-frame" id="consultForm" th:action="@{/consultation}" method="post" th:object="${booking}" autocomplete="off">
        <input type="hidden" id="consultation_type" name="consultation_type" th:field="*{consultationType}">
        
        <div class="form-section">
            <label for="fullname" class="required-field">Họ tên</label>
            <input type="text" id="fullname" name="fullname" th:field="*{fullname}" required maxlength="100" placeholder="Nhập họ tên">
        </div>
        
        <div class="form-section">
            <label for="phone" class="required-field">Số điện thoại</label>
            <input type="tel" id="phone" name="phone" th:field="*{phone}" required maxlength="20" pattern="[0-9\+\-\s]{9,20}" placeholder="Nhập số điện thoại">
        </div>
        
        <div class="form-section">
            <label for="email" class="required-field">Email</label>
            <input type="email" id="email" name="email" th:field="*{email}" required maxlength="100" placeholder="Email nhận xác nhận">
        </div>
        
        <div class="form-section">
            <label for="service" class="required-field">Chọn dịch vụ tư vấn</label>
            <select id="service" name="service" th:field="*{service}" required>
                <option value="" disabled selected>-- Chọn dịch vụ --</option>
                <option value="Tham vấn tâm lý học đường">Tham vấn tâm lý học đường</option>
                <option value="Giải đáp, phòng ngừa sử dụng ma túy">Giải đáp, phòng ngừa sử dụng ma túy</option>
                <option value="Hỗ trợ phụ huynh - trẻ vị thành niên">Hỗ trợ phụ huynh - trẻ vị thành niên</option>
                <option value="Phục hồi & cai nghiện">Phục hồi & cai nghiện</option>
            </select>
        </div>
        
        <div class="form-section">
            <label for="consultant" class="required-field">Chọn chuyên gia tư vấn</label>
            <select id="consultant" name="consultant" th:field="*{consultant}" required>
                <option value="" disabled selected>-- Chọn chuyên gia --</option>
                <option value="hung">BS. Nguyễn Văn Hùng - Tâm lý, Cai nghiện</option>
                <option value="lan">Phạm Thị Lan - Trẻ vị thành niên</option>
                <option value="quan">TS. Trần Minh Quân - Gia đình, Xã hội</option>
                <option value="hien">BS. Lê Thu Hiền - Học đường</option>
            </select>
        </div>
        
        <div class="form-section">
            <label for="booking_date" class="required-field">Chọn ngày</label>
            <input type="date" id="booking_date" name="booking_date" th:field="*{bookingDate}" required min="">
        </div>
        
        <div class="form-section">
            <label class="required-field">Chọn giờ tư vấn</label>
            <div class="hour-list" id="hourList">
                <div class="no-slots-available">Vui lòng chọn chuyên gia và ngày</div>
            </div>
            <input type="hidden" id="booking_time" name="booking_time" th:field="*{bookingTime}">
        </div>
        
        <div class="form-section">
            <label for="note">Mô tả tình trạng (tùy chọn)</label>
            <textarea id="note" name="note" th:field="*{note}" placeholder="Bạn muốn tư vấn về điều gì?"></textarea>
        </div>
        
        <div class="form-actions">
            <button type="button" class="cancel-btn" onclick="closeBookingForm()">Hủy</button>
            <button type="submit" class="consult-btn" id="submitBtn">
                <span id="submitText">Đặt lịch</span>
            </button>
        </div>
    </form>
</div>

<!-- Success Modal -->
<div class="success-modal" id="successModal">
    <div class="success-icon">
        <i class="fas fa-check-circle"></i>
    </div>
    <h2 class="success-title">Đặt lịch thành công!</h2>
    <p class="success-message">
        Cảm ơn bạn đã đặt lịch tư vấn. Chúng tôi đã gửi thông tin xác nhận đến email của bạn.
        Vui lòng kiểm tra email để biết thêm chi tiết.
    </p>
    <div class="success-actions">
        <button class="success-btn btn-home" onclick="goToHomePage()">
            <i class="fas fa-home"></i> Về trang chủ
        </button>
        <button class="success-btn btn-new" onclick="continueBooking()">
            <i class="fas fa-calendar-plus"></i> Đặt lịch mới
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const methodCards = document.querySelectorAll('.method-card');
    const consultForm = document.getElementById('consultForm');
    const consultationTypeInput = document.getElementById('consultation_type');
    const consultantSelect = document.getElementById('consultant');
    const dateInput = document.getElementById('booking_date');
    const hourList = document.getElementById('hourList');
    const bookingTimeInput = document.getElementById('booking_time');
    const formContainer = document.getElementById('formContainer');
    const overlay = document.getElementById('overlay');
    const successModal = document.getElementById('successModal');
    let selectedMethod = '';
    let selectedHour = '';

    // Khởi tạo ngày tối thiểu là ngày hiện tại
    function initMinDate() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.min = `${yyyy}-${mm}-${dd}`;
        dateInput.value = dateInput.min;
    }

    // Hiển thị form đặt lịch
    function showBookingForm() {
        formContainer.style.display = 'block';
        overlay.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    // Đóng form đặt lịch
    function closeBookingForm() {
        formContainer.style.display = 'none';
        overlay.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Hiển thị modal thành công
    function showSuccessModal() {
        closeBookingForm();
        successModal.classList.add('show');
        overlay.style.display = 'block';
    }

    // Ẩn modal thành công
    function hideSuccessModal() {
        successModal.classList.remove('show');
        overlay.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Điều hướng về trang chủ
    function goToHomePage() {
        window.location.href = '/';
    }

    // Tiếp tục đặt lịch mới
    function continueBooking() {
        hideSuccessModal();
        consultForm.reset();
        initMinDate();
        hourList.innerHTML = '<div class="no-slots-available">Vui lòng chọn chuyên gia và ngày</div>';
        showBookingForm();
    }

    // Xử lý khi chọn phương thức tư vấn
    function handleMethodSelection(card) {
        methodCards.forEach(c => {
            c.classList.remove('selected');
            const quickContact = c.querySelector('.quick-contact-container');
            if (quickContact) quickContact.style.display = 'none';
        });
        
        card.classList.add('selected');
        selectedMethod = card.dataset.method;
        consultationTypeInput.value = selectedMethod;

        // Hiển thị quick contact cho hotline/social
        const quickContact = card.querySelector('.quick-contact-container');
        if (quickContact) quickContact.style.display = 'flex';

        if (['online', 'offline'].includes(selectedMethod)) {
            showBookingForm();
            initMinDate();
            updateAvailableHours();
        } else {
            closeBookingForm();
        }
    }

    // Cập nhật giờ trống từ API
    function updateAvailableHours() {
        hourList.innerHTML = '';
        selectedHour = '';
        bookingTimeInput.value = '';
        const doctor = consultantSelect.value;
        const date = dateInput.value;
        
        if (!doctor || !date) {
            hourList.innerHTML = '<div class="no-slots-available">Vui lòng chọn chuyên gia và ngày</div>';
            return;
        }
        
        // Gọi API để lấy giờ trống thực tế từ server
        fetch(`/api/available-hours?doctor=${doctor}&date=${date}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Lỗi khi lấy giờ trống');
                }
                return response.json();
            })
            .then(hours => {
                if (hours.length === 0) {
                    hourList.innerHTML = '<div class="no-slots-available">Không có giờ trống. Vui lòng chọn ngày khác.</div>';
                    return;
                }
                
                hours.forEach(hour => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'hour-btn';
                    btn.textContent = hour;
                    btn.onclick = function() {
                        document.querySelectorAll('.hour-btn').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        selectedHour = hour;
                        bookingTimeInput.value = hour;
                    };
                    hourList.appendChild(btn);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                hourList.innerHTML = `<div class="no-slots-available">${error.message}</div>`;
            });
    }

    // Xử lý submit form bằng AJAX
    function handleFormSubmit(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        submitText.textContent = 'Đang xử lý...';
        submitBtn.disabled = true;
        
        // Kiểm tra xem đã chọn giờ chưa
        if (!bookingTimeInput.value) {
            alert('Vui lòng chọn giờ tư vấn');
            submitText.textContent = 'Đặt lịch';
            submitBtn.disabled = false;
            return;
        }
        
        // Gửi dữ liệu bằng AJAX
        fetch(consultForm.action, {
            method: consultForm.method,
            body: new FormData(consultForm),
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Lỗi khi gửi dữ liệu');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showSuccessModal();
            } else {
                alert('Đặt lịch thất bại: ' + (data.message || 'Vui lòng thử lại sau'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra: ' + error.message);
        })
        .finally(() => {
            submitText.textContent = 'Đặt lịch';
            submitBtn.disabled = false;
        });
    }

    // Gắn sự kiện
    methodCards.forEach(card => {
        card.addEventListener('click', () => handleMethodSelection(card));
    });

    consultantSelect.addEventListener('change', updateAvailableHours);
    dateInput.addEventListener('change', updateAvailableHours);
    consultForm.addEventListener('submit', handleFormSubmit);

    // Khởi tạo form
    initMinDate();
    
    // Copy hotline function
    window.copyHotline = function(e) {
        e.preventDefault();
        navigator.clipboard.writeText('1800 1111').then(() => {
            const originalText = e.target.innerHTML;
            e.target.innerHTML = '<i class="fa fa-check"></i> Đã sao chép';
            setTimeout(() => {
                e.target.innerHTML = originalText;
            }, 2000);
        });
    };
});
</script>
</body>
</html>