<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Khảo sát & Trắc nghiệm | Drug Prevention Support System</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2176ae;
            --secondary: #57b8ff;
            --bg: #f7fbfd;
            --white: #fff;
            --soft: #eaf4fa;
            --shadow: 0 6px 32px 0 rgba(33,118,174,0.13);
        }
        html, body { width: 100%; min-width: 0; overflow-x: hidden !important; box-sizing: border-box;}
        * { box-sizing: inherit; }
        body {
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            background: var(--bg);
            margin: 0;
            color: #24415d;
        }
        .main-wrap {
            max-width: 1440px;
            width: 90vw;
            margin: 0 auto;
            padding: 0 0 60px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .section {
            width: 100%;
            margin: 38px 0 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .section-title {
            font-size: 2.25rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 28px;
            text-align: center;
            letter-spacing: 0.02em;
            text-shadow: 0 1px 10px #2176ae14;
            animation: titleFade 1s;
        }
        @keyframes titleFade {
            from { opacity: 0; transform: translateY(-18px);}
            to   { opacity: 1; transform: translateY(0);}
        }
        .survey-filter-bar {
            background: #fff;
            box-shadow: 0 2px 12px #2176ae15;
            border-radius: 14px;
            padding: 19px 34px 10px 34px;
            display: flex;
            gap: 18px;
            margin-bottom: 27px;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
        }
        .survey-filter-bar select, .survey-filter-bar input[type="text"] {
            font-family: inherit;
            border-radius: 8px;
            border: 1px solid #b7d8f5;
            font-size: 1.03em;
            padding: 7px 16px;
            background: #f4fbff;
            color: #274060;
            outline: none;
            margin-right: 8px;
        }
        .survey-filter-bar input[type="text"] { width: 195px; }
        .survey-grid {
            width: 100%;
            max-width: 1260px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 36px;
            margin: 0 auto 24px auto;
            align-items: stretch;
        }
        .survey-card {
            background: var(--white);
            border-radius: 17px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-height: 288px;
            padding: 0 0 22px 0;
            transition: box-shadow 0.17s, transform 0.13s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            animation: surveyFadeIn 0.55s;
        }
        @keyframes surveyFadeIn {
            from { opacity:0; transform:scale(0.97) translateY(28px);}
            to { opacity:1; transform:scale(1) translateY(0);}
        }
        .survey-card:active { transform: scale(0.97);}
        .survey-card:focus-within { outline: 2px solid var(--secondary);}
        .survey-card:hover {
            box-shadow: 0 16px 42px #2176ae16;
            transform: translateY(-4px) scale(1.014);
        }
        .survey-ribbon {
            position: absolute;
            top: 19px; left: -36px;
            background: linear-gradient(90deg, #21ae66 60%, #57b8ff 100%);
            color: #fff;
            font-weight: 700;
            font-size: 1.01em;
            padding: 6px 58px 6px 50px;
            transform: rotate(-19deg);
            border-radius: 8px 22px 12px 0;
            box-shadow: 0 3px 10px #57b8ff25;
            letter-spacing: 0.04em;
            z-index: 2;
            animation: popIn 0.65s;
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8) rotate(-19deg);}
            to   { opacity: 1; transform: scale(1) rotate(-19deg);}
        }
        .survey-card-img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-top-left-radius: 17px;
            border-top-right-radius: 17px;
            background: #eaf6fa;
            box-shadow: 0 2px 10px #57b8ff0f;
        }
        .survey-card-body {
            padding: 19px 21px 0 21px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
        }
        .survey-title {
            font-size: 1.20em;
            font-weight: 800;
            color: #1c2f49;
            margin-bottom: 10px;
        }
        .survey-type {
            font-size: 0.98em;
            color: #2176ae;
            font-weight: 600;
            background: #e6f4fa;
            border-radius: 7px;
            padding: 2.5px 11px;
            margin-bottom: 7px;
            display: inline-block;
        }
        .survey-topic {
            font-size: 0.97em;
            color: #57b8ff;
            font-weight: 500;
            margin-left: 7px;
        }
        .survey-desc {
            font-size: 1.01em;
            color: #4b637f;
            margin-bottom: 13px;
        }
        .survey-card-footer {
            margin-top: auto;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: space-between;
        }
        .survey-info {
            color: #6fa3ce;
            font-size: 0.97em;
            display: flex;
            align-items: center;
            gap: 7px;
        }
        .survey-btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(90deg, #2176ae 85%, #57b8ff 100%);
            color: #fff;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.15s, box-shadow 0.13s, transform 0.13s;
            box-shadow: 0 1px 5px #2176ae18;
        }
        .survey-btn:active { transform: scale(0.97);}
        .survey-btn:hover {
            background: linear-gradient(90deg, #21ae66 80%, #3eaafc 100%);
            box-shadow: 0 4px 13px #21ae6624;
            transform: scale(1.04);
        }
        #noSurveyMsg {
            display: none;
            color: #57b8ff;
            font-weight: 500;
            font-size: 1.13em;
            text-align: center;
            padding: 28px 0 0 0;
        }
        /* Responsive */
        @media (max-width: 1100px) {
            .main-wrap { width: 98vw;}
            .survey-grid { max-width: 99vw;}
        }
        @media (max-width: 900px) {
            .main-wrap { width: 99vw;}
        }
        @media (max-width: 650px) {
            .section-title { font-size: 1.4rem;}
            .main-wrap { width: 100vw;}
            .survey-filter-bar { flex-direction: column; gap: 10px; padding: 12px 6px 7px 6px;}
            .survey-grid { gap: 14px;}
        }
    </style>
</head>
<body>
<div th:replace="member/header :: main-header"></div>
<div class="main-wrap">
    <section class="section">
        <div class="section-title">
            <i class="fa-solid fa-clipboard-list"></i> Danh sách Khảo sát & Trắc nghiệm
        </div>
        <div class="survey-filter-bar">
            <select id="filterType">
                <option value="">Tất cả loại</option>
                <option value="Trắc nghiệm">Trắc nghiệm</option>
                <option value="Đánh giá mức độ">Đánh giá mức độ</option>
                <option value="Tự luận">Tự luận</option>
                <option value="Tổng hợp">Tổng hợp</option>
            </select>
            <select id="filterTopic">
                <option value="">Tất cả chủ đề</option>
                <option value="Nhận thức về ma túy">Nhận thức về ma túy</option>
                <option value="Kỹ năng phòng tránh">Kỹ năng phòng tránh</option>
                <option value="Tâm lý - hành vi">Tâm lý - hành vi</option>
            </select>
            <input id="searchInput" type="text" placeholder="Tìm kiếm khảo sát...">
        </div>
    </section>
    <section class="section">
        <div class="survey-grid" id="surveyGrid">
            <div class="survey-card"
     th:each="test : ${tests}"
     th:attr="data-id=${test.id},data-type=${test.type},data-topic=${test.topic},data-title=${test.name},data-desc=${test.description}">

                <!-- Ribbon nếu muốn -->
                <span class="survey-ribbon" th:if="${test.type == 'Trắc nghiệm' || test.type == 'Đánh giá mức độ'}"
                      th:text="${test.type == 'Trắc nghiệm' ? 'Hot' : (test.type == 'Đánh giá mức độ' ? 'Mới' : '')}"></span>
                <!-- Ảnh mô tả -->
                <img class="survey-card-img" th:src="${test.image}" th:alt="${test.name}"/>
                <div class="survey-card-body">
                    <div class="survey-title" th:text="${test.name}"></div>
                    <span class="survey-type" th:text="${test.type}"></span>
                    <span class="survey-topic"><i class="fa fa-hashtag"></i> <span th:text="${test.topic}"></span></span>
                    <div class="survey-desc" th:text="${test.description}"></div>
                    <div class="survey-card-footer">
                        <div class="survey-info">
                            <i class="fa fa-question-circle"></i>
                            <span th:if="${test.type == 'Trắc nghiệm'}" th:text="${test.questionCount + ' câu'}"></span>
                            <span th:if="${test.type == 'Tự luận'}">1 bài tự luận</span>
                            <span th:if="${test.type == 'Đánh giá mức độ'}" th:text="${test.questionCount + ' câu điểm số'}"></span>
                            <span th:if="${test.type == 'Tổng hợp'}">Tổng hợp nhiều dạng</span>
                        </div>
                        <button class="survey-btn" type="button">Bắt đầu</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="noSurveyMsg" style="display:none;color:#57b8ff;font-weight:500;font-size:1.13em;text-align:center;padding:28px 0 0 0;">
            Không tìm thấy khảo sát nào phù hợp.
        </div>
    </section>
</div>
<!-- Modal xác nhận -->
<div id="surveyConfirmModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:14px; box-shadow:0 8px 32px #2176ae33; padding:36px 26px; min-width:320px; max-width:95vw; text-align:center;">
        <div style="font-size:1.2em; font-weight:600; margin-bottom:18px;">Xác nhận bắt đầu khảo sát?</div>
        <div style="margin-bottom:22px; color:#2176ae;" id="surveyConfirmTitle"></div>
        <button id="surveyConfirmOk" style="background: #2176ae; color:#fff; border:none; border-radius:8px; padding:9px 24px; font-weight:600; margin-right:16px; cursor:pointer;">Xác nhận</button>
        <button id="surveyConfirmCancel" style="background: #eaf4fa; color:#2176ae; border:none; border-radius:8px; padding:9px 18px; font-weight:500; cursor:pointer;">Huỷ</button>
    </div>
</div>

<div th:replace="member/footer :: main-footer"></div>
<script>
    // --- Lọc và tìm kiếm hoàn toàn trên giao diện (JS, không động tới backend) ---
    document.addEventListener('DOMContentLoaded', function() {
        const cards = Array.from(document.querySelectorAll('.survey-card'));
        const filterType = document.getElementById('filterType');
        const filterTopic = document.getElementById('filterTopic');
        const searchInput = document.getElementById('searchInput');
        const noMsg = document.getElementById('noSurveyMsg');

        function doFilter() {
            let type = filterType.value;
            let topic = filterTopic.value;
            let keyword = searchInput.value.trim().toLowerCase();
            let found = 0;
            cards.forEach(card => {
                let t = card.getAttribute('data-type');
                let tp = card.getAttribute('data-topic');
                let title = card.getAttribute('data-title').toLowerCase();
                let desc = card.getAttribute('data-desc').toLowerCase();
                let matched = true;
                if (type && t !== type) matched = false;
                if (topic && tp !== topic) matched = false;
                if (keyword && !title.includes(keyword) && !desc.includes(keyword)) matched = false;
                card.style.display = matched ? '' : 'none';
                if (matched) found++;
            });
            noMsg.style.display = found === 0 ? '' : 'none';
        }
        filterType.addEventListener('change', doFilter);
        filterTopic.addEventListener('change', doFilter);
        searchInput.addEventListener('input', doFilter);
          // Bắt popup xác nhận
    const modal = document.getElementById('surveyConfirmModal');
    const confirmOk = document.getElementById('surveyConfirmOk');
    const confirmCancel = document.getElementById('surveyConfirmCancel');
    const confirmTitle = document.getElementById('surveyConfirmTitle');
    let nextSurveyUrl = "#";

    // Lặp tất cả nút "Bắt đầu"
    document.querySelectorAll('.survey-btn').forEach(function(btn, idx) {
        btn.addEventListener('click', function(e) {
            // Lấy id hoặc tên test để chuyển tiếp
            const card = btn.closest('.survey-card');
            const testName = card.getAttribute('data-title');
            // Giả sử có trường id test (nên render hidden, hoặc render data-id ở survey-card)
            // Ở đây sẽ ví dụ data-id:
            const testId = card.getAttribute('data-id') || ""; // bạn cần bổ sung th:attr="data-id=${test.id}" vào survey-card

            // Tạo url tới trang làm bài khảo sát (bạn tự xử lý route backend)
            nextSurveyUrl = "/tests/" + testId + "/do"; // ví dụ
            confirmTitle.textContent = testName;
            modal.style.display = "flex";
        });
    });

    confirmOk.onclick = function() {
        modal.style.display = "none";
        window.location.href = nextSurveyUrl;
    }
    confirmCancel.onclick = function() {
        modal.style.display = "none";
        nextSurveyUrl = "#";
    }
    // Đóng popup khi bấm ngoài modal
    modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.style.display = "none";
    });
    });
</script>
</body>
</html>