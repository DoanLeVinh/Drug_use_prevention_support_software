<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Lịch Hẹn Tư Vấn | Drug Use Prevention Support System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ICON & CSS FRAMEWORK -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        :root {
            --primary: #2176ae;
            --secondary: #57b8ff;
            --accent: #ff7043;
            --light: #f6fbff;
            --shadow: 0 2px 8px rgba(33, 118, 174, 0.07);
            --border: #e3eaf2;
            --radius: 12px;
            --danger: #e74c3c;
            --success: #21ae66;
            --warning: #fbc02d;
            --text: #233044;
        }
        html, body {
            height: 100%;
            background: var(--light);
        }
        body {
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            min-height: 100vh;
            width: 100vw;
            box-sizing: border-box;
        }
        /* Header full width, sát mép trên */
        .main-header {
            margin: 0;
            padding: 0;
            border-radius: 0 !important;
        }
        .main-header-inner {
            max-width: none !important;
            margin: 0 !important;
            padding: 0 36px;
            width: 100vw;
        }

        /* Nội dung full màn hình */
        .staff-app-container {
            width: 100vw;
            min-height: calc(100vh - 60px);
            background: none;
            border-radius: 0;
            box-shadow: none;
            padding: 0 36px 36px 36px;
            margin: 0;
            box-sizing: border-box;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .brand {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            letter-spacing: 1px;
        }
        .role-badge {
            font-size: 0.96rem;
            background: var(--secondary);
            color: #fff;
            padding: 6px 22px;
            border-radius: 32px;
            font-weight: 600;
            box-shadow: 0 1px 5px #e6eef7;
            text-transform: uppercase;
        }
        .quote {
            background: linear-gradient(90deg, var(--primary) 60%, var(--secondary) 100%);
            color: #fff;
            border-radius: var(--radius);
            padding: 14px 28px;
            font-size: 1.12rem;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 1px 8px #dde6f2;
        }
        .quote i {
            font-size: 1.5rem;
            opacity: 0.8;
        }
        .section-title {
            font-size: 1.24rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--primary);
        }
        .filter-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 22px;
            background: #f2f8fd;
            padding: 18px 16px;
            border-radius: var(--radius);
            margin-bottom: 28px;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }
        .filter-group {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
        }
        .filter-item label {
            display: block;
            font-size: 0.98em;
            color: #336699;
            margin-bottom: 5px;
        }
        .filter-item select,
        .filter-item input {
            min-width: 135px;
            padding: 7px 11px;
            border: 1px solid var(--border);
            border-radius: 7px;
            font-size: 1em;
        }
        .action-buttons {
            display: flex;
            gap: 12px;
        }
        .btn {
            padding: 9px 19px;
            border: none;
            border-radius: var(--radius);
            font-size: 1em;
            cursor: pointer;
            transition: 0.18s;
            display: flex;
            align-items: center;
            gap: 7px;
            font-weight: 500;
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
        }
        .btn-primary:hover {
            background: var(--secondary);
        }
        .btn-outline {
            background: #fff;
            color: var(--primary);
            border: 1.5px solid var(--primary);
        }
        .btn-outline:hover {
            background: var(--light);
        }
        /* Table */
        .table-responsive {
            overflow-x: auto;
            width: 100%;
        }
        .appointment-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }
        .appointment-table th,
        .appointment-table td {
            padding: 12px 16px;
            font-size: 1em;
        }
        .appointment-table th {
            background: #eaf3fa;
            text-align: left;
            color: #255c88;
            text-transform: uppercase;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }
        .appointment-table td {
            border-bottom: 1px solid #f3f3f3;
            color: #232e33;
        }
        .appointment-table tr:hover td {
            background: #f8fcfe;
        }
        .user-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }
        .badge {
            display: inline-block;
            padding: 5px 13px;
            border-radius: 7px;
            font-size: 0.92em;
            font-weight: 600;
        }
        .badge-success {
            background: #eafaf1;
            color: var(--success);
        }
        .badge-warning {
            background: #fffbe2;
            color: var(--warning);
        }
        .badge-info {
            background: #e9f7fe;
            color: var(--primary);
        }
        .badge-cancelled {
            background: #f8dddd;
            color: var(--danger);
        }
        .action-cell {
            display: flex;
            gap: 8px;
        }
        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.12em;
            transition: 0.18s;
        }
        .action-btn:hover {
            background: #eaf2fb;
        }
        .action-btn.edit {
            color: var(--primary);
        }
        .action-btn.delete {
            color: var(--danger);
        }
        .action-btn.view {
            color: var(--success);
        }
        .action-btn.confirm {
            color: var(--secondary);
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0;
            width: 100vw; height: 100vh;
            background: rgba(33, 118, 174, 0.13);
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: #fff;
            border-radius: 10px;
            width: 100%;
            max-width: 450px;
            box-shadow: var(--shadow);
            padding: 25px 28px 18px 28px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .modal-close {
            border: none;
            background: none;
            font-size: 1.5rem;
            color: #aaa;
            cursor: pointer;
        }
        .modal-close:hover {
            color: var(--danger);
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 22px;
            gap: 12px;
        }
        @media (max-width: 900px) {
            .staff-app-container, .main-header-inner {
                padding-left: 2vw;
                padding-right: 2vw;
            }
            .modal-content {padding: 15px 7vw 18px 7vw;}
        }
        @media (max-width: 700px) {
            .staff-app-container, .main-header-inner {
                padding-left: 0;
                padding-right: 0;
            }
            .filter-toolbar {
                flex-direction: column;
                gap: 12px;
            }
            .table-responsive {
                font-size: 0.96em;
            }
            .modal-content {padding: 6px 1vw 14px 1vw;}
        }
    </style>
</head>
<body>

<!-- HEADER FULL WIDTH -->
<div th:replace="staff/header :: main-header"></div>

<!-- NỘI DUNG CHÍNH FULL WIDTH -->
<div class="staff-app-container">

    <!-- FILTER BAR -->
    <form class="filter-toolbar" method="get" th:action="@{/staff/appointments}">
        <div class="filter-group">

            <div class="filter-item">
                <label for="filter-status">Trạng thái</label>
                <select id="filter-status" name="status">
                    <option value="">Tất cả</option>
                    <option value="pending"   th:selected="${status=='pending'}">Chờ xác nhận</option>
                    <option value="confirmed" th:selected="${status=='confirmed'}">Đã xác nhận</option>
                    <option value="completed" th:selected="${status=='completed'}">Hoàn thành</option>
                    <option value="cancelled" th:selected="${status=='cancelled'}">Đã hủy</option>
                </select>
            </div>

            <div class="filter-item">
                <label for="filter-consultant">Chuyên viên</label>
                <select id="filter-consultant" name="consultantId">
                    <option value="">Tất cả</option>
                    <option th:each="consultant : ${consultants}"
                            th:value="${consultant.id}"
                            th:text="${consultant.fullName}"
                            th:selected="${consultant.id == consultantId}">Chuyên viên</option>
                </select>
            </div>

            <div class="filter-item">
                <label for="filter-date-from">Từ ngày</label>
                <input id="filter-date-from"
                       name="from"
                       type="date"
                       th:value="${from}">
            </div>

            <div class="filter-item">
                <label for="filter-date-to">Đến ngày</label>
                <input id="filter-date-to"
                       name="to"
                       type="date"
                       th:value="${to}">
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-outline" type="submit">
                <i class="fa fa-filter"></i>
                Lọc lịch hẹn
            </button>
            <button class="btn btn-primary" type="button" id="openAddAppointment">
                <i class="fa fa-plus"></i>
                Thêm lịch hẹn
            </button>
        </div>
    </form>

    <!-- TABLE LỊCH HẸN -->
    <div class="table-responsive" style="margin-bottom: 34px;">
        <table class="appointment-table">
            <thead>
            <tr>
                <th>Mã</th>
                <th>Người đặt</th>
                <th>Chuyên viên</th>
                <th>Thời gian</th>
                <th>Hình thức</th>
                <th>Trạng thái</th>
                <th>Hành động</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="appointment : ${appointments}">
                <td th:text="${appointment.code}">APT001</td>
                <td>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <img th:src="@{${appointment.user.avatarUrl}}"
                             src="https://randomuser.me/api/portraits/men/32.jpg"
                             class="user-avatar"
                             th:if="${appointment.user.avatarUrl}">
                        <img src="https://randomuser.me/api/portraits/men/32.jpg"
                             class="user-avatar"
                             th:unless="${appointment.user.avatarUrl}">
                        <span th:text="${appointment.user.fullName}">Nguyễn Văn A</span>
                    </div>
                </td>
                <td th:text="${appointment.consultant.fullName}">Trần Thị B</td>
                <td>
                    <div th:text="${appointment.time} + ' - ' + ${appointment.date}">10:00 - 15/07/2023</div>
                </td>
                <td th:text="${appointment.type == 'online' ? 'Trực tuyến' : 'Trực tiếp'}">Trực tiếp</td>
                <td>
                    <span th:switch="${appointment.status}" class="badge">
                        <span th:case="'pending'" class="badge-warning">Chờ xác nhận</span>
                        <span th:case="'confirmed'" class="badge-success">Đã xác nhận</span>
                        <span th:case="'completed'" class="badge-info">Hoàn thành</span>
                        <span th:case="'cancelled'" class="badge-cancelled">Đã hủy</span>
                    </span>
                </td>
                <td>
                    <div class="action-cell">
                        <button class="action-btn view"
                                type="button"
                                th:attr="data-id=${appointment.id}"
                                title="Xem chi tiết">
                            <i class="fa fa-eye"></i>
                        </button>
                        <button class="action-btn edit"
                                type="button"
                                th:if="${appointment.status != 'completed' && appointment.status != 'cancelled'}"
                                title="Chỉnh sửa">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="action-btn delete"
                                type="button"
                                th:if="${appointment.status != 'completed' && appointment.status != 'cancelled'}"
                                title="Hủy lịch">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(appointments)}">
                <td colspan="7" style="text-align:center;color:#bbb;padding:24px 0;">
                    Không có lịch hẹn nào phù hợp.
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- MODAL THÊM LỊCH HẸN (ẩn/hiện bằng JS) -->
    <div id="addAppointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span style="font-size:1.08em;font-weight:600;">
                    Thêm lịch hẹn mới
                </span>
                <button class="modal-close" type="button"
                        onclick="document.getElementById('addAppointmentModal').classList.remove('show')">
                    &times;
                </button>
            </div>
            <form th:action="@{/staff/appointments}" method="post" th:object="${newAppointment}">
                <div class="form-group" style="margin-bottom:13px;">
                    <label for="add-user">Người đặt</label>
                    <select id="add-user" name="userId" required style="width:100%;">
                        <option value="">Chọn người đặt</option>
                        <option th:each="user : ${users}"
                                th:value="${user.id}"
                                th:text="${user.fullName} + ' (' + ${user.code} + ')'">
                            Nguyễn Văn A (USR001)
                        </option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom:13px;">
                    <label for="add-consultant">Chuyên viên</label>
                    <select id="add-consultant" name="consultantId" required style="width:100%;">
                        <option value="">Chọn chuyên viên</option>
                        <option th:each="consultant : ${consultants}"
                                th:value="${consultant.id}"
                                th:text="${consultant.fullName}">
                            Trần Thị B
                        </option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom:13px;">
                    <label for="add-date">Ngày hẹn</label>
                    <input id="add-date"
                           type="date"
                           name="date"
                           required
                           style="width:100%;">
                </div>
                <div class="form-group" style="margin-bottom:13px;">
                    <label for="add-time">Giờ hẹn</label>
                    <input id="add-time"
                           type="time"
                           name="time"
                           required
                           style="width:100%;">
                </div>
                <div class="form-group" style="margin-bottom:13px;">
                    <label for="add-type">Hình thức tư vấn</label>
                    <select id="add-type" name="type" required style="width:100%;">
                        <option value="online">Trực tuyến</option>
                        <option value="offline">Trực tiếp</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom:15px;">
                    <label for="add-note">Ghi chú</label>
                    <textarea id="add-note"
                              name="note"
                              rows="3"
                              style="width:100%;"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline"
                            onclick="document.getElementById('addAppointmentModal').classList.remove('show')">
                        Hủy bỏ
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Lưu lịch hẹn
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>

<!-- SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // Modal open
    document.getElementById('openAddAppointment').onclick = function() {
        document.getElementById('addAppointmentModal').classList.add('show');
    };
    // Close modal bằng phím ESC
    window.addEventListener('keydown', function(e){
        if (e.key === "Escape") {
            document.getElementById('addAppointmentModal').classList.remove('show');
        }
    });

    // Flatpickr (nâng cấp nếu cần)
    flatpickr("#add-date", {dateFormat: "Y-m-d", minDate: "today"});
    flatpickr("#filter-date-from", {dateFormat: "Y-m-d"});
    flatpickr("#filter-date-to", {dateFormat: "Y-m-d"});
</script>

</body>
</html>
